/**
 * Module dependencies.
 */

var mocha = require("mocha")
  , Base = mocha.reporters.Base
  , utils = mocha.utils
  , escape = utils.escape;
// var Base = require('mocha/libs/reporters/base')
  // , utils = require('mocha/libs/utils');


/**
 * Expose `htmlreporter`
 */

exports = module.exports = htmlreporter;

/**
 * Initialize a new `htmlreporter` reporter.
 *
 * @param {Runner} runner
 * @api public
 */
function htmlreporter(runner) {
  Base.call(this, runner);

  var self = this
    , stats = this.stats
    , level = 2
    , buf = '';


  runner.on('start', function() {
    console.log('<html><head><title>Test Results</title><link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet"/><link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"/><style type="text/css">.green {color: green !important;}\n.red {color: red !important;}\n</style>');

    console.log('</head><body>');
    console.log('<div class="container"><div class="row"><div class="span8">');
  });


  runner.on('suite', function(suite) {
    if (suite.title) {
      buf += '<h' + level + '>' + suite.title + '</h' + level + '>\n';
      level++;
      if (suite.tests.length > 0)
        buf += '<table>\n';
    }
  });

  runner.on('pass', function(test){
    buf += '<tr><td class="green"><i class="icon-check green"></i></td><td>' + test.title + '</td></tr>\n';
    // duration, speed= slow/fast
  });

  runner.on('fail', function(test, err){
    buf += '<tr><td class="red"><i class="icon-check-empty red"></i></td><td>' + test.title + '</td></tr>\n';
  });

  runner.on('suite end', function(suite) {
    if (suite.title) {
      if (suite.tests.length > 0)
        buf += '</table>\n';
      level--;
    }
  });

  runner.on('end', function(){
    console.log('<h1>Test Results</h1>');
    console.log('<p>Ran %d tests with %d failures</p>', stats.tests, stats.failures);
    console.log('<p>Tests completed in %d ms</p>', stats.duration);
    console.log(buf);
    console.log('</div></div></div>');
    console.log('</body></html>');
    process.exit(stats.failures);
  });
}
